<?php

namespace Model;
use ActiveRecord, System;

class Job extends \App\Permission
{
    /**
     * Name of the table related to the User Model
     *
     * @var string
     */
    static string $table_name = 'jobs';

    static array $schema = array(
        "id"            => "bigint(250) NOT NULL AUTO_INCREMENT",
        "uuid"          => "text NOT NULL",
        "user_id"       => "bigint(250) NOT NULL",
        "tenant_id"     => "bigint(250) NOT NULL",
        "data"          => "text DEFAULT NULL",
        "created_at"    => "timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP",
        "updated_at"    => "timestamp NOT NULL DEFAULT '0000-00-00 00:00:00'",
        "started_at"    => "timestamp NOT NULL DEFAULT '0000-00-00 00:00:00'",
        "completed_at"  => "timestamp NOT NULL DEFAULT '0000-00-00 00:00:00'",
        "job"           => "text DEFAULT NULL",
        "status"        => "int(5) NOT NULL DEFAULT '0'",
        "pid"           => "int(5) NOT NULL DEFAULT '0'",
        "percentage"    => "int(5) NOT NULL DEFAULT '0'",
    );

    public static function create(array $attributes, $validate = true)
    {
        if(!isset($attributes['uuid'])) {
            $attributes['uuid'] = gen_uuid();
        }
        if(!isset($attributes['data'])) {
            $attributes['data'] = json_encode(array());
        } else {
            $attributes['data'] = json_encode($attributes['data']);
        }
        if(!isset($attributes['user_id'])) {
            $user = get_session_user();
            $attributes['user_id'] = $user?$user->id:0;
        }
        if(!isset($attributes['tenant_id'])) {
            $tenant = get_session_tenant();
            $attributes['tenant_id'] = $tenant?$tenant->id:0;
        }
        return parent::create($attributes, $validate); // TODO: Change the autogenerated stub
    }

    public function exec()
    {
        $this->pid = \Kernel()->runCLI('/job/' . $this->id . '/run');
        $this->save();
    }

    public function log($message, $type='info')
    {

    }

    public function done($step_name)
    {

    }

    public function percentage_add($number)
    {

    }

    public function complete($message='')
    {

    }

    public function fail($message='')
    {

    }




}